---
layout:  post
title:   FFmpeg 命令
date:    2020-9-27
author:  Tangle
catalog: true
tags:
    - FFmpeg
---

```
ffmpeg -h         # 帮助
ffmpeg video.mp4  # 播放
ffprobe video.mp4 # 参数信息
```

# 格式转换

```
-codec copy     # 表示所有的流都不进行再次编码
-threads 2      # 多线程
-hwaccel cuvid  # 完全通过显卡 GPU 完成
-c:v h264_nvenc # 视频编码
-ss             # 剪辑开始时间
-t              # 剪辑持续时间
```

```
ffmpeg -i main.mkv main.mp4                                                         # 单个
for %a in ("*.mkv") do ffmpeg -threads 2 -i "%a" "%~na.mp4"                         # 多个
for /r %a in ("*.mkv") do ffmpeg -threads 2 -i "%a" "%~pna.mp4"                     # 多目录
for /r %a in ("*.mkv") do ffmpeg -hwaccel cuvid -i "%a" -c:v h264_nvenc "%~pna.mp4" # 通过 GPU 多目录
```

# 水印

## 动态水印

```
ffmpeg -y -t 30 -i test.mp4 -i logo1.png -filter_complex [1:v]colorchannelmixer=aa=0.3[valpha];[0:v][valpha]overlay=lt(mod(t\,20)):x='(W-w)/2':y='mod(t,20)*60-h' move.mp4
```

# 下载

## m3u8

```
ffmpeg -i "https://videos3.jianzhuluntan.com/20201223/ovg-149/index.m3u8" -c copy out.ts
```

# 串联

```
ffmpeg -i move.mp4 -i move.mp4 -i output.ts -filter_complex "[0:v:0][0:a:0][1:v:0][1:a:0][2:v:0][2:a:0]concat=n=3:v=1:a=1[outv][outa]" -map "[outv]" -map "[outa]"  output9.mkv
```

# 改变编码

## 编码，音频转码

```
ffmpeg -codecs # 查看编解码器
```

### 常用编码

| 格式 | 视频编码 | 音频编码 |
| ---- | -------- | -------- |
| mp4  | H.264    | ACC      |
| webm | VP8      | Vorbis   |
| ogg  | Theora   | Vprbis   |

### 无损编码

```
acodec        # audio Coder Decoder 音频编码解码器
libmp3lame    # mp3 解码器
ar:audio rate # 音频采样率
44100         # 设置音频的采样率 44100
ab            # audio bit rate 音频比特率
320k          # 设置音频的比特率，默认128K
ac            # aduio channels 音频声道
```

```
ffmpeg -i music_flac.flac -acodec libmp3lame -ar 44100 -ab 320k -ac 2 music_flac_mp3.mp3
```

## 视频压制

```
-s 1920x1080     # 缩放视频新尺寸（size）
-pix_fmt yuv420p # pixel format 用来设置视频颜色空间。参数查询：ffmpeg -pix_fmts
-vcodec libx264  # video Coder Decoder 视频编码解码器
-preset medium   # 编码器预设。参数：ultrafast，superfast，veryfast，faster，fast，medium，slow，slower，veryslow，placebo
-profile:v high  # 编码器配置，与压缩比有关。实时通讯 -baseline流，媒体-main，超清视频 -high
-level:v 4.1     # 对编码器设置的具体规范和限制，权衡压缩比和画质
-crf 23          # 设置码率控制模式。constant rate factor 恒定速率因子模式。范围0~51，默认23。数值越小，画质越高。一般在 8~28 做出选择。
-r 30            # 设置视频帧率
-acodec aac      # audio Coder Decoder 音频编码解码器
-b:a 128k        # 音频比特率，大多数网站限制音频比特率 128k，129k
```

```
ffmpeg -i video.mp4 -s 1920x1080 -pix_fmt yuv420p -vcodec libx264 -preset medium -profile:v high -level:v 4.1 -crf 23 -acodec aac -ar 44100 -ac 2 -b:a 128k video_avi.avi
```

## 码率控制模式

ffmpeg 支持的码率控制模式：`-qp -crf -b`

```
-qp :constant quantizer,恒定量化器模式
无损压缩的例子（快速编码）
ffmpeg -i input -vcodec libx264 -preset ultrafast -qp 0 output.mkv
无损压缩的例子（高压缩比）
ffmpeg -i input -vcodec libx264 -preset veryslow -qp 0 output.mkv
```

```
-crf :constant rate factor,恒定速率因子模式
```

```
-b ：bitrate,固定目标码率模式。一般不建议使用
```

3种模式默认单遍编码

```
VBR(Variable Bit Rate/动态比特率) 例子
ffmpeg -i input -vcodec libx264 -preset veryslow output
ABR(Average Bit Rate/平均比特率) 例子
ffmpeg -i input -vcodec libx264 -preset veryslow -b:v 3000k output
CBR(Constant Bit Rate/恒定比特率) 例子
... -b:v 4000k -minrate 4000k -maxrate 4000k -bufsize 1835k ...
```

# 合并，提取音视频

```
(1)单独提取视频（不含音频流）
ffmpeg -i video.mp4 -vcodec copy -an video_silent.mp4
(2)单独提取音频（不含视频流）
ffmpeg -i video.mp4 -vn -acodec copy video_novideo.m4a

具备多个音频流的，如
Stream #0:2[0x81]:Audio:ac3,48000Hz,5.1,s16,384kb/s
Stream #0:3[0x82]:Audio:ac3,48000Hz,5.1,s16,384kb/s
Stream #0:4[0x80]:Audio:ac3,48000Hz,5.1,s16,448kb/s

针对性的单一的提取，例如提取第2条，用指令： -map 0:3
(3)合并音视频
ffmpeg -i video_novideo.m4a -i video_silent.mp4 -c copy video_merge.mp4
```

# 截取，连接音视频

```
(1)截取
ffmpeg -i music.mp3 -ss 00:00:30 -to 00:02:00 -acodec copy music_cutout.mp3
截取60秒
ffmpeg -i music.mp3 -ss 00:00:30 -t 60 -acodec copy music_cutout60s.mp3

-sseof : 从媒体末尾开始截取

ffmpeg -i in.mp4 -ss 00:01:00 -to 00:01:10 -c copy out.mp4
ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy out.mp4
ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy -copyts out.mp4

把-ss放到-i之前，启用了关键帧技术，加速操作。但截取的时间段不一定准确。可用最后一条指令，保留时间戳，保证时间准确。
(2)连接音视频
ffmpeg -i "concat:01.mp4|02.mp4|03.mp4" -c copy out.mp4

不同格式的音视频可以连接在一起，但不推荐不同格式连接在一起。
建议使用Avidemux软件连接
```

# 截图，水印，动图

```
(1)截图.
截取第7秒第1帧的画面
ffmpeg -i video.mp4 -ss 7 -vframes 1 video_image.jpg
(2)水印
ffmpeg -i video.mp4 -i qt.png -filter_complex "overlay=20:80" video_watermark.mp4
(3)截取动图
ffmpeg -i video.mp4 -ss 7.5 -to 8.5 -s 640x320 -r 15 video_gif.gif
```

# 录屏，直播

```
(1)录屏
windows: ffmpeg -f gdigrab -i desktop rec.mp4
ubuntu: sudo ffmpeg -f fbdev -framerate 10 -i /dev/fb0 rec.mp4

gdigrab ：ffmpeg中的一个组件。
只捕获视频.若要录屏，录音，获取摄像头，麦克风，换组件，用OBS Studio软件

(2)直播
ffmpeg -re i rec.mp4 按照网站要求编码 -f flv "你的rtmp地址/你的直播码"
```

# 参考

## 中文文档

- <https://www.bookstack.cn/read/other-doc-cn-ffmpeg/README.md>

- <https://www.mekau.com/4992.html>

## 其他

- <https://blog.csdn.net/qq_21275565/article/details/103671164>

- <https://blog.csdn.net/yu540135101/article/details/103025957?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-13.control&dist_request_id=1328627.12660.16153937976558383&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-13.control>
