---
layout:  post
title:   FFmpeg 命令
date:    2020-9-27
author:  Tangle
catalog: true
tags:
    - FFmpeg
---

# 常用

## 编码

```
-c:v h264_nvenc  # h264 GPU
-vcodec libx264  # h264
-r 60            # 帧率
-b 5.9M          # 固定比特率
-pix_fmt yuv420p # 像素格式
-crf 23          # 恒定速率因子
```

```
ffmpeg -i input.mp4 -c:v h264_nvenc -s 1920x1080 -r 60 -crf 23 output.mp4
```

## 格式转换

```
for /r %i in ("*.mkv") do ffmpeg -i "%i" -c:v h264_nvenc "%~pna.mp4"
```

# 帮助

```
ffmpeg -h        # 帮助
ffplay -h        # 帮助
ffprobe -h       # 帮助
ffmpeg -codecs   # 编解码器
ffmpeg -pix_fmts # 像素格式
```

# 调试

```
ffplay video.mp4  # 播放
ffprobe video.mp4 # 参数信息
```

# 表达式

- 浏览 <https://www.bookstack.cn/read/other-doc-cn-ffmpeg/ffmpeg-doc-cn-08.md>

```
expr1;expr2 # 两个表达式都会被计算，但是新表达式值实为表达式 expr2 的值
```

## 变量

```
expr # 表达式
```

```
st(var, expr) # 对 var 变量在内部存储一个 expr 值，供以后使用，var 范围为 0-9，注意这些变量当前不能在表达式间共享
ld(var)       # 加载预订的内部变量 var 对应值，其中值是利用 st(var, expr) 存储的
```

# 格式转换

```
-codec copy     # 表示所有的流都不进行再次编码
-threads 2      # 多线程
-hwaccel cuvid  # 完全通过显卡 GPU 完成
-c:v h264_nvenc # 视频编码
-ss             # 剪辑开始时间
-t              # 剪辑持续时间
```

```
ffmpeg -i main.mkv main.mp4                                                         # 单个
for %a in ("*.mkv") do ffmpeg -threads 2 -i "%a" "%~na.mp4"                         # 多个
for /r %a in ("*.mkv") do ffmpeg -threads 2 -i "%a" "%~pna.mp4"                     # 多目录
for /r %a in ("*.mkv") do ffmpeg -hwaccel cuvid -i "%a" -c:v h264_nvenc "%~pna.mp4" # 通过 GPU 多目录
```

# 水印

## 动态水印

```
mod(t,20) # 取余一周期 20秒
main_w, W # 主输入宽度
w         # 福输入宽度
```

```
ffmpeg -y -t 30 -i 1080p+.mp4 -i 水印.png -filter_complex [1:v]colorchannelmixer=aa=0.3[valpha];[0:v][valpha]overlay=:x='(W-w)/2':y='mod(t,20)*60-h' -c:v h264_nvenc -s 1920x1080 -r 60 -crf 23 move.mp4
```

```
# 60秒四角随机
ffmpeg -i input.mp4 -i input.png -filter_complex "overlay='if(ld(0), if(lte(mod(t/60,1),0.05),st(0,0);NAN,ld(1)), st(0,1);if(lte(random(t),0.5),st(1,0),st(1,main_w-overlay_w));NAN)':'if(ld(0), if(lte(mod(t/60,1),0.05),st(0,0);NAN,ld(1)), st(0,1);if(lte(random(t),0.5),st(1,0),st(1,main_h-overlay_h));NAN)'" output.mp4

# 解析
ffmpeg -i input.mp4 -i input.png -filter_complex "overlay=x='
    if(
        ld(0), 
        if(lte(mod(t/10,1),0.05),
            st(0,0);NAN,
            ld(1)
        ),
        st(0,1);if(
            lte(random(t),0.5),
            st(1,0),
            st(1,main_w-overlay_w)
        );NAN
    )
':y='
    if(
        ld(0),
        if(lte(mod(t/10,1),0.05),
            st(0,0);NAN,
            ld(1)
        ),
        st(0,1);if(
            lte(random(t),0.5),
            st(1,0),
            st(1,main_h-overlay_h)
        );NAN
    )
'" output.mp4
```

## 静态水印

```
ffmpeg -i video.mp4 -i qt.png -filter_complex "overlay=20:80" video_watermark.mp4
```

# 下载

## m3u8

```
ffmpeg -i "https://videos3.jianzhuluntan.com/20201223/ovg-149/index.m3u8" -c copy out.ts
```

# 串联

```
ffmpeg -i move.mp4 -i move.mp4 -i output.ts -filter_complex "[0:v:0][0:a:0][1:v:0][1:a:0][2:v:0][2:a:0]concat=n=3:v=1:a=1[outv][outa]" -map "[outv]" -map "[outa]"  output9.mkv
```

```
ffmpeg -i move.mp4 -c copy -bsf:v h264_mp4toannexb -f mpegts intermediate1.ts
ffmpeg -i move.mp4 -c copy -bsf:v h264_mp4toannexb -f mpegts intermediate2.ts
ffmpeg -i "concat:intermediate1.ts|intermediate2.ts" -c copy -bsf:a aac_adtstoasc output.mp4
```

# 截图

## 静态图

```
ffmpeg -i test.mp4 -ss 7 -vframes 1 video_image.jpg # 第7秒第1帧
```

## 动态图

```
ffmpeg -i video.mp4 -ss 7.5 -to 8.5 -s 640x320 -r 15 video_gif.gif # 7.5-8.5秒
```

# 编码

## 帧率

```
ffmpeg -i input.avi -r 30 output.mp4 # 帧率
```

## 比特率

```
ffmpeg -i file.avi -b 1.5M file.mp4       # 音视频比特率
ffmpeg -i input.avi -b:v 1500K output.mp4 # 视频比特率
```

## 音频转码

### 常用编码

| 格式 | 视频编码 | 音频编码 |
| ---- | -------- | -------- |
| mp4  | H.264    | ACC      |
| webm | VP8      | Vorbis   |
| ogg  | Theora   | Vprbis   |

### 无损编码

```
-acodec libmp3lame # 编解码器（audio Coder Decoder），mp3 解码器
ar 44100           # 音频采样率
ab 320k            # 音频比特率（audio bit rate），默认 128K
ac 2               # 音频声道（aduio channels）
```

```
ffmpeg -i music_flac.flac -acodec libmp3lame -ar 44100 -ab 320k -ac 2 music_flac_mp3.mp3
```

## 视频压制

```
-s 1920x1080     # 缩放视频新尺寸（size）
-pix_fmt yuv420p # 用来设置视频颜色空间（pixel format）
-vcodec libx264  # 视频编解码器（video Coder Decoder）
-preset medium   # 编码器预设，参数：ultrafast，superfast，veryfast，faster，fast，medium，slow，slower，veryslow，placebo
-profile:v high  # 编码器配置，与压缩比有关，实时通讯 -baseline 流，媒体 -main，超清视频 -high
-level:v 4.1     # 对编码器设置的具体规范和限制，权衡压缩比和画质
-crf 23          # 设置码率控制模式，恒定速率因子模式（constant rate factor），范围 0-51，默认 23，数值越小，画质越高，一般在 8-28 做出选择
-r 30            # 设置视频帧率
-acodec aac      # 音频编码解码器（audio Coder Decoder）
-b:a 128k        # 音频比特率，大多数网站限制音频比特率 128k，129k
```

```
ffmpeg -i video.mp4 -s 1920x1080 -pix_fmt yuv420p -vcodec libx264 -preset medium -profile:v high -level:v 4.1 -crf 23 -acodec aac -ar 44100 -ac 2 -b:a 128k video_avi.avi
```

## 码率控制模式

- ffmpeg 支持的码率控制模式

```
-qp  # 恒定量化器模式（constant quantizer）
-crf # 恒定速率因子模式(constant rate factor)
-b   # 固定目标码率模式（bitrate），一般不建议使用
```

```
ffmpeg -i input -vcodec libx264 -preset ultrafast -qp 0 output.mkv # 无损压缩（快速编码）
ffmpeg -i input -vcodec libx264 -preset veryslow -qp 0 output.mkv  # 无损压缩（高压缩比）
```

```
# 动态比特率 VBR（Variable Bit Rate）
ffmpeg -i input -vcodec libx264 -preset veryslow output

# 平均比特率 ABR（Average Bit Rate）
ffmpeg -i input -vcodec libx264 -preset veryslow -b:v 3000k output

# 恒定比特率 CBR（Constant Bit Rate）
ffmpeg -i input -vcodec libx264 -preset veryslow -b:v 4000k -minrate 4000k -maxrate 4000k -bufsize 1835k output
```

# 合并，提取音视频

```
# 单独提取视频（不含音频流）
ffmpeg -i video.mp4 -vcodec copy -an video_silent.mp4

# 单独提取音频（不含视频流）
ffmpeg -i video.mp4 -vn -acodec copy video_novideo.m4a

# 具备多个音频流的
Stream #0:2[0x81]:Audio:ac3,48000Hz,5.1,s16,384kb/s
Stream #0:3[0x82]:Audio:ac3,48000Hz,5.1,s16,384kb/s
Stream #0:4[0x80]:Audio:ac3,48000Hz,5.1,s16,448kb/s

# 针对性的单一的提取，提取第2条，用指令：-map 0:3

# 合并音视频
ffmpeg -i video_novideo.m4a -i video_silent.mp4 -c copy video_merge.mp4
```

# 截取，连接音视频

```
# 截取
ffmpeg -i music.mp3 -ss 00:00:30 -to 00:02:00 -acodec copy music_cutout.mp3

# 截取60秒
ffmpeg -i music.mp3 -ss 00:00:30 -t 60 -acodec copy music_cutout60s.mp3

-sseof # 从媒体末尾开始截取

ffmpeg -i in.mp4 -ss 00:01:00 -to 00:01:10 -c copy out.mp4
ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy out.mp4
ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy -copyts out.mp4

把 -ss 放到 -i 之前，启用了关键帧技术，加速操作，但截取的时间段不一定准确，可用最后一条指令，保留时间戳，保证时间准确

# 连接音视频
ffmpeg -i "concat:01.mp4|02.mp4|03.mp4" -c copy out.mp4
```

# 录屏，直播

```
# 录屏
ffmpeg -f gdigrab -i desktop rec.mp4              # window
ffmpeg -f fbdev -framerate 10 -i /dev/fb0 rec.mp4 # ubuntu

gdigrab # ffmpeg中的一个组件
只捕获视频.若要录屏，录音，获取摄像头，麦克风，换组件，用 OBS Studio 软件

# 直播
ffmpeg -re i rec.mp4 按照网站要求编码 -f flv "你的rtmp地址/你的直播码"
```

# 参考

## 中文文档

- <https://www.bookstack.cn/read/other-doc-cn-ffmpeg/README.md>

- <https://www.mekau.com/4992.html>

## 英文文档

- <http://trac.ffmpeg.org/wiki>

## 其他

- <https://blog.csdn.net/qq_21275565/article/details/103671164>

- <https://blog.csdn.net/yu540135101/article/details/103025957?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-13.control&dist_request_id=1328627.12660.16153937976558383&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-13.control>
